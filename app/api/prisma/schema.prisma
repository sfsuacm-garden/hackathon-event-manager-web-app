generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "../src/zod"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Application {
  id                        String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId                   String              @map("event_id") @db.Uuid
  userId                    String              @map("user_id") @db.Uuid
  status                    String?             @default("pending")
  school                    String?
  graduationYear            Int?                @map("graduation_year")
  experienceLevel           String?             @map("experience_level")
  submissionData            String?               @map("submission_data")
  createdAt                 DateTime?           @default(now()) @map("created_at") @db.Timestamp(6)
  publicStatus              application_status? @map("public_status")
  internalStatus            application_status? @map("internal_status")
  schoolId                  String?             @map("school_id") @db.Uuid
  dob                       String?
  phoneNumber               String?             @map("phone_number")
  levelOfStudy              String?             @map("level_of_study")
  countryOfResidence        String?             @map("country_of_residence")
  linkedinUrl               String?             @map("linkedin_url")
  mlhAuthorizedPromoEmail   Boolean?            @map("mlh_authorized_promo_email")
  mlhAuthorizedDataShare    Boolean?            @map("mlh_authorized_data_share")
  mlhCodeOfConductAgreement Boolean?            @map("mlh_code_of_conduct_aggreemeant")
  dietaryVegetarian         Boolean?            @map("dietary_vegetarian")
  dietaryVegan              Boolean?            @map("dietary_vegan")
  dietaryCeliacDisease      Boolean?            @map("dietary_celiac_disease")
  dietaryKosher             Boolean?            @map("dietary_kosher")
  dietaryHalal              Boolean?            @map("dietary_halal")
  gender                    String?
  pronouns                  String?
  raceEthnicity             String?             @map("race_ethnicity")
  sexualOrientation         String?             @map("sexual_orientation")
  educationLevel            String?             @map("education_level")
  tshirtSize                t_shirt_size?       @map("tshirt_size")
  majorFieldOfStudy         String?             @map("major_field_of_study")
  schoolEmail               String?             @map("school_email")
  event                     Event               @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profile                   UserProfile         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eventId, userId])
  @@map("applications")
}

model Event {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String
  description          String?
  startDate            DateTime?      @map("start_date") @db.Timestamp(6)
  endDate              DateTime?      @map("end_date") @db.Timestamp(6)
  createdAt            DateTime?      @default(now()) @map("created_at") @db.Timestamp(6)
  isEventLive          Boolean?       @map("is_event_live")
  isTeamManagementOpen Boolean?       @map("is_team_managment_open")
  applications         Application[]
  eventProfiles        EventProfile[]
  mailingLists         MailingList[]
  team_members         TeamMember[]
  teams                Team[]

  @@map("events")
}

model MailingListMember {
  mailingListId String      @map("mailing_list_id") @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  mailingList   MailingList @relation(fields: [mailingListId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profile       UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([mailingListId, userId])
  @@map("mailing_list_members")
}

model MailingList {
  id        String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId   String?             @map("event_id") @db.Uuid
  name      String
  createdAt DateTime?           @default(now()) @map("created_at") @db.Timestamp(6)
  members   MailingListMember[]
  event     Event?              @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("mailing_lists")
}

model School {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  countryCode   String              @map("country_code")
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  stateProvince String?             @map("state_province")
  emailDomains  SchoolEmailDomain[]

  @@map("schools")
}

model TeamMember {
  teamId   String      @map("team_id") @db.Uuid
  userId   String      @map("user_id") @db.Uuid
  isAdmin  Boolean?    @map("is_admin")
  joinedAt DateTime?   @default(dbgenerated("(now() AT TIME ZONE 'utc'::text)")) @map("joined_at") @db.Timestamp(6)
  event_id String      @db.Uuid
  events   Event       @relation(fields: [event_id], references: [id], onDelete: Cascade)
  team     Team        @relation(fields: [teamId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profile  UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([teamId, userId])
  @@map("team_members")
}

model Team {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId        String?          @map("event_id") @db.Uuid
  name           String?
  createdAt      DateTime?        @default(now()) @map("created_at") @db.Timestamp(6)
  joinTeamTokens JoinTeamTokens?
  members        TeamMember[]
  event          Event?           @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  teamsBlacklist TeamsBlacklist[]

  @@map("teams")
}

model EventProfile {
  createdAt DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  profileId String               @map("profile_id") @db.Uuid
  eventId   String               @map("event_id") @db.Uuid
  role      participation_level? @default(hacker)
  event     Event                @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  profile   UserProfile          @relation(fields: [profileId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([profileId, eventId])
  @@map("event_profiles")
}

model SchoolEmailDomain {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  schoolId  String   @map("school_id") @db.Uuid
  domain    String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("school_email_domains")
}

model UserProfile {
  id             String              @id(map: "profiles_pkey") @default(dbgenerated("auth.uid()")) @db.Uuid
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamp(6)
  firstName      String?             @map("first_name")
  lastName       String?             @map("last_name")
  dob            String?
  phoneNumber    String?             @map("phone_number")
  applications   Application[]
  eventProfiles  EventProfile[]
  mailingLists   MailingListMember[]
  teamMembers    TeamMember[]
  teamsBlacklist TeamsBlacklist[]

  @@map("user_profiles")
}

model JoinTeamTokens {
  token     String   @id @default(dbgenerated("encode(gen_random_bytes(32), 'hex'::text)"))
  teamId    String   @unique @map("team_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime @default(dbgenerated("(now() + '00:20:00'::interval)")) @map("expires_at") @db.Timestamptz(6)
  teams     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("join_team_tokens")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model TeamsBlacklist {
  teamId      String      @default(dbgenerated("gen_random_uuid()")) @map("team_id") @db.Uuid
  userId      String      @default(dbgenerated("gen_random_uuid()")) @map("user_id") @db.Uuid
  teams       Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userProfile UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([teamId, userId])
  @@map("teams_blacklist")
}

enum application_status {
  pending
  rejected
  accepted
  waitlisted
}

enum participation_level {
  hacker
  judge
  organizer
}

enum t_shirt_size {
  US_XS
  US_S
  US_M
  US_L
  US_XL
  US_XXL
  UK_6
  UK_8
  UK_10
  UK_12
  UK_14
  UK_16
}
